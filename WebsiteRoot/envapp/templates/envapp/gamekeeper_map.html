{% include 'envapp/navbar.html' %}
{% load static %}

{% block content %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gamekeeper Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

</head>

<body>
    <div class="container" style="display:flex">
        <div class="form-container" >
            <h4>Create a New Water Station</h4>
            <form method="POST" style="width: 100%; box-sizing: border-box;">
                {% csrf_token %}
                {{ waterStationForm.as_p }}
                <button type="submit" class="btn-primary">Create Water Station</button>
            </form>
        </div>

        <div id="map" style="flex: 4; background-color: lightgray; height: 100%;"></div>
    </div>


    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([50.7374, -3.5352], 16);
        var tempMarker = null;
        const newStation = L.icon({
            iconUrl: "{% static 'images/waterStation.jpg' %}",
            iconSize: [38, 38],
            });
        var waterStationsLayer = L.layerGroup();
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data: © OpenStreetMap contributors, SRTM | Map style: © OpenTopoMap (CC-BY-SA)'
        }).addTo(map);

        {% for station in water_stations %}
            var popUpForm = `
            <h2>Name: {{ station.name }}<br>Location description: {{ station.location_description }}<br>Points: {{ station.points_reward }}</h2>
            <form method ="POST" action="{% url 'gamekeeper_map' %}">
                {% csrf_token %}
                <input type="hidden" name="station_id" value="{{ station.id }}">
                <button type="submit" class="btn-primary">Remove</button>
            </form>`;
                
            var marker = L.marker([{{ station.latitude }}, {{ station.longitude }}])
                .bindPopup(popUpForm)
                .on("click", function () {
                    map.flyTo(this.getLatLng(), 17);
                    });
            waterStationsLayer.addLayer(marker);
        {% endfor %}
        waterStationsLayer.addTo(map);

        map.on('click', function (e) {
            var lat = e.latlng.lat;
            var lon = e.latlng.lng;
            if (tempMarker) {
                map.removeLayer(tempMarker);
                }
            tempMarker = L.marker([lat, lon],{ icon: newStation }).addTo(map);
            document.getElementById("id_latitude").value = lat;
            document.getElementById("id_longitude").value = lon;
            });

        document.getElementById("waterStationForm").onsubmit = function (event) {
        event.preventDefault();
        };

    </script>
</body>

</html>
{% endblock %}