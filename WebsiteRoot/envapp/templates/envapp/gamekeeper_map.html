{% include 'envapp/navbar.html' %}
{% load static %}

{% block content %}
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gamekeeper Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">

    <style>
        /* âœ… Ensure map is large */
        #map {
            height: 600px;
            width: 100%;
        }

        /* âœ… Style floating point labels */
        .map-label {
            font-size: 14px;
            font-weight: bold;
            color: black;
            background: rgba(255, 255, 255, 0.9);
            padding: 5px;
            border-radius: 5px;
            text-align: center;
            width: auto;
            white-space: nowrap;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>

<body>
    <div class="container" style="display:flex">
        <div class="form-container">
            <h4>Create a New Water Station</h4>
            <form method="POST" enctype="multipart/form-data" style="width: 100%; box-sizing: border-box;">
                {% csrf_token %}
                {{ waterStationForm.as_p }}
                <button type="submit" class="btn-primary">Create Water Station</button>
            </form>
        </div>

        <div id="map" style="flex: 4; background-color: lightgray; height: 600px;"></div>
    </div>

    {% if water_stations|length > 0 %}
        <h3 class="mt-4">Reported Water Stations</h3>
        <table class="table table-bordered mt-2">
            <thead>
                <tr>
                    <th>Name</th>
                    <th>Location</th>
                    <th>Reports</th>
                    <th>Status</th>
                    <th>Photo</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for station in water_stations %}
                    {% if station.reports > 0 %} {# âœ… Only show reported stations in the grid #}
                    <tr>
                        <td>{{ station.name }}</td>
                        <td>{{ station.location_description }}</td>
                        <td>
                            <span class="badge bg-warning">{{ station.reports }}</span>
                        </td>
                        <td>
                            {% if station.is_working %}
                                <span class="badge bg-success">Working</span>
                            {% else %}
                                <span class="badge bg-danger">Not Working</span>
                            {% endif %}
                        </td>
                        <td>
                            {% if station.photo %}
                                <img src="{{ station.photo.url }}" width="100">
                            {% else %}
                                <span class="text-muted">No Image</span>
                            {% endif %}
                        </td>
                        <td>
                            <form method="POST" action="{% url 'reset_report' station.id %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-secondary btn-sm">Reset Reports</button>
                            </form>
                            <form method="POST" action="{% url 'gamekeeper_map' %}">
                                {% csrf_token %}
                                <input type="hidden" name="station_id" value="{{ station.id }}">
                                <button type="submit" class="btn btn-danger btn-sm mt-2">Remove</button>
                            </form>
                        </td>
                    </tr>
                    {% endif %}
                {% endfor %}
            </tbody>
        </table>
    {% else %}
        <h3 class="mt-4 text-muted">No reported water stations</h3>
    {% endif %}

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
        const map = L.map('map').setView([50.7374, -3.5352], 16);
        var tempMarker = null;
        const newStation = L.icon({
            iconUrl: "{% static 'images/waterStation.jpg' %}",
            iconSize: [38, 38],
        });
        var waterStationsLayer = L.layerGroup();

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Map data: Â© OpenStreetMap contributors'
        }).addTo(map);

        {% for station in water_stations %}
            var stationImage = `{% if station.photo %}<img src="{{ station.photo.url }}" width="150" style="border-radius: 10px;">{% else %}<span class="text-muted">No Image Available</span>{% endif %}`;

            var stationStatus = `{% if station.is_working %}<span class="badge bg-success">âœ… Working</span>{% else %}<span class="badge bg-danger">ðŸš¨ Not Working</span>{% endif %}`;

            var popUpForm = `
            <h2>Name: {{ station.name }}</h2>
            <p>Location: {{ station.location_description }}</p>
            <p><strong>Points:</strong> {{ station.points_reward }}</p>
            <p><strong>Status:</strong> ${stationStatus}</p>
            ${stationImage}

            <form method="POST" action="{% url 'gamekeeper_map' %}">
                {% csrf_token %}
                <input type="hidden" name="station_id" value="{{ station.id }}">
                <button type="submit" class="btn btn-danger btn-sm mt-2">Remove</button>
            </form>`;

            var marker = L.marker([{{ station.latitude }}, {{ station.longitude }}])
                .bindPopup(popUpForm)
                .on("click", function () {
                    map.flyTo(this.getLatLng(), 17);
                });

            waterStationsLayer.addLayer(marker);
        {% endfor %}
        waterStationsLayer.addTo(map);

        map.on('click', function (e) {
            var lat = e.latlng.lat;
            var lon = e.latlng.lng;
            if (tempMarker) {
                map.removeLayer(tempMarker);
            }
            tempMarker = L.marker([lat, lon], { icon: newStation }).addTo(map);
            document.getElementById("id_latitude").value = lat;
            document.getElementById("id_longitude").value = lon;
        });

        document.getElementById("waterStationForm").onsubmit = function (event) {
            event.preventDefault();
        };
    </script>

</body>

</html>
{% endblock %}
